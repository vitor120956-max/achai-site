<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acha√≠ - Melhores Produtos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; }
        header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            padding: 20px; 
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { font-size: 28px; font-weight: bold; margin-bottom: 15px; }
        .search-box { 
            display: flex; 
            gap: 10px; 
            max-width: 500px; 
            margin: 0 auto;
        }
        input { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            border-radius: 10px; 
            font-size: 16px;
        }
        button.search-btn {
            padding: 15px 25px;
            background: #16a34a;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }
        .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px; 
        }
        .card { 
            background: white; 
            border-radius: 16px; 
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .card img { 
            width: 100%; 
            height: 200px; 
            object-fit: cover; 
            background: #eee;
        }
        .card-body { padding: 15px; }
        .seller { 
            font-size: 12px; 
            color: #666; 
            margin-bottom: 5px;
        }
        .card-title { 
            font-size: 15px; 
            font-weight: 600; 
            margin-bottom: 10px;
            line-height: 1.4;
            height: 42px;
            overflow: hidden;
        }
        .price { 
            font-size: 24px; 
            font-weight: bold; 
            color: #111; 
            margin-bottom: 10px;
        }
        .price-original {
            font-size: 14px;
            color: #999;
            text-decoration: line-through;
            margin-bottom: 5px;
        }
        .rating {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .stars { color: #fbbf24; }
        .trust-badge {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
        }
        .trust-high { background: #f0fdf4; color: #16a34a; }
        .trust-medium { background: #fffbeb; color: #d97706; }
        .trust-low { background: #fef2f2; color: #dc2626; }
        .btn-comprar {
            display: block;
            width: 100%;
            padding: 14px;
            background: #2563eb;
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
        }
        .error-box { 
            background: #fef2f2; 
            color: #dc2626; 
            padding: 20px; 
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        .retry-btn {
            margin-top: 15px;
            padding: 12px 24px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header { position: relative; }
        .modal-header img {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }
        .modal-close {
            position: absolute;
            top: 15px; right: 15px;
            width: 40px; height: 40px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
        }
        .modal-body { padding: 20px; }
        .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .stat {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #2563eb;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .analysis-box {
            background: #eff6ff;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        .analysis-box h4 { color: #2563eb; margin-bottom: 10px; }
        .shipping {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .shipping.free { background: #f0fdf4; color: #16a34a; }
        .shipping.paid { background: #fef2f2; color: #dc2626; }
    </style>
</head>
<body>
    <header>
        <div class="logo">‚úÖ Acha√≠</div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="O que voc√™ procura?" value="fone bluetooth">
            <button class="search-btn" onclick="buscar()">Buscar</button>
        </div>
    </header>
    
    <div class="container">
        <div id="resultado">
            <div class="loading">üîç Clique em Buscar para come√ßar</div>
        </div>
    </div>
    
    <div class="modal" id="modal" onclick="fecharModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <img id="modalImg" src="" alt="">
                <button class="modal-close" onclick="fecharModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        const AFILIADO_ID = 'SEU_ID_AQUI';
        
        // PRODUTOS DE FALLBACK (quando API falha)
        const PRODUTOS_FALLBACK = [
            {
                id: 'fb1',
                title: 'Fone de Ouvido Bluetooth JBL Tune 510BT - Preto',
                price: 199.90,
                original_price: 299.90,
                thumbnail: 'https://http2.mlstatic.com/D_NQ_NP_987650-MLA47585767953_092021-O.webp',
                permalink: 'https://www.mercadolivre.com.br/fone-de-ouvido-jbl-tune-510bt-preto/p/MLB16073780',
                seller: { nickname: 'JBL Oficial', seller_reputation: { level_id: '5_green', transactions: { completed: 52340 } } },
                rating_average: 4.8,
                rating_total: 15420,
                shipping: { free_shipping: true, logistic_type: 'fulfillment' }
            },
            {
                id: 'fb2',
                title: 'Fone Bluetooth QCY T13 TWS Original - Branco',
                price: 89.90,
                original_price: 149.90,
                thumbnail: 'https://http2.mlstatic.com/D_NQ_NP_765432-MLA45678901234_082021-O.webp',
                permalink: 'https://www.mercadolivre.com.br/fone-bluetooth-qcy-t13/p/MLB12345678',
                seller: { nickname: 'Tech Imports BR', seller_reputation: { level_id: '4_light_green', transactions: { completed: 8750 } } },
                rating_average: 4.5,
                rating_total: 3240,
                shipping: { free_shipping: true, logistic_type: 'cross_docking' }
            },
            {
                id: 'fb3',
                title: 'Fone Bluetooth Xiaomi Redmi Buds 4 Lite - Preto',
                price: 129.00,
                original_price: 179.00,
                thumbnail: 'https://http2.mlstatic.com/D_NQ_NP_123456-MLA56789012345_092022-O.webp',
                permalink: 'https://www.mercadolivre.com.br/fone-xiaomi-redmi-buds-4-lite/p/MLB23456789',
                seller: { nickname: 'Xiaomi Store BR', seller_reputation: { level_id: '5_green', transactions: { completed: 125000 } } },
                rating_average: 4.7,
                rating_total: 8900,
                shipping: { free_shipping: true, logistic_type: 'fulfillment' }
            },
            {
                id: 'fb4',
                title: 'Fone Bluetooth Sony WH-CH520 - Azul',
                price: 349.00,
                original_price: 499.00,
                thumbnail: 'https://http2.mlstatic.com/D_NQ_NP_654321-MLA98765432109_032023-O.webp',
                permalink: 'https://www.mercadolivre.com.br/fone-sony-wh-ch520/p/MLB34567890',
                seller: { nickname: 'Sony Brasil', seller_reputation: { level_id: '5_green', transactions: { completed: 89000 } } },
                rating_average: 4.6,
                rating_total: 5670,
                shipping: { free_shipping: true, logistic_type: 'fulfillment' }
            },
            {
                id: 'fb5',
                title: 'Fone Bluetooth Apple AirPods 2 - Branco',
                price: 899.00,
                original_price: 1299.00,
                thumbnail: 'https://http2.mlstatic.com/D_NQ_NP_111111-MLA44444444444_052020-O.webp',
                permalink: 'https://www.mercadolivre.com.br/apple-airpods-2/p/MLB45678901',
                seller: { nickname: 'Apple Oficial', seller_reputation: { level_id: '5_green', transactions: { completed: 200000 } } },
                rating_average: 4.9,
                rating_total: 45200,
                shipping: { free_shipping: true, logistic_type: 'fulfillment' }
            },
            {
                id: 'fb6',
                title: 'Fone Bluetooth Baseus Bowie E18 - Preto',
                price: 79.90,
                original_price: 129.90,
                thumbnail: 'https://http2.mlstatic.com/D_NQ_NP_222222-MLA55555555555_112022-O.webp',
                permalink: 'https://www.mercadolivre.com.br/fone-baseus-bowie-e18/p/MLB56789012',
                seller: { nickname: 'Baseus Official', seller_reputation: { level_id: '4_light_green', transactions: { completed: 15600 } } },
                rating_average: 4.3,
                rating_total: 1890,
                shipping: { free_shipping: false, logistic_type: 'not_specified' }
            }
        ];
        
        function getTrustScore(item) {
            const rating = item.rating_average || 0;
            const reviews = item.rating_total || 0;
            const seller = item.seller?.seller_reputation?.level_id || '';
            const sales = item.seller?.seller_reputation?.transactions?.completed || 0;
            
            let score = 50;
            score += (rating / 5) * 25;
            if (reviews > 1000) score += 15;
            else if (reviews > 100) score += 10;
            else if (reviews > 10) score += 5;
            if (seller.includes('5')) score += 10;
            else if (seller.includes('4')) score += 5;
            if (sales > 10000) score += 10;
            else if (sales > 1000) score += 5;
            if (item.shipping?.free_shipping) score += 5;
            
            return Math.min(Math.round(score), 99);
        }
        
        function getTrustClass(score) {
            if (score >= 85) return 'trust-high';
            if (score >= 60) return 'trust-medium';
            return 'trust-low';
        }
        
        function formatarPreco(valor) {
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        function criarLinkAfiliado(url) {
            if (AFILIADO_ID === 'SEU_ID_AQUI') return url;
            return `${url}?afiliado=${AFILIADO_ID}`;
        }
        
        async function buscar() {
            const termo = document.getElementById('searchInput').value.trim();
            if (!termo) return;
            
            const resultado = document.getElementById('resultado');
            resultado.innerHTML = '<div class="loading">üîç Buscando melhores produtos...</div>';
            
            // Tenta m√∫ltiplas fontes de API
            const tentativas = [
                // Tentativa 1: Proxy do Vercel (se existir)
                () => fetch(`/api/buscar?q=${encodeURIComponent(termo)}`),
                
                // Tentativa 2: API p√∫blica com CORS
                () => fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(
                    `https://api.mercadolibre.com/sites/MLB/search?q=${encodeURIComponent(termo)}&limit=20`
                )}`).then(r => r.json()).then(j => ({ json: () => JSON.parse(j.contents) })),
                
                // Tentativa 3: Outro proxy CORS
                () => fetch(`https://corsproxy.io/?${encodeURIComponent(
                    `https://api.mercadolibre.com/sites/MLB/search?q=${encodeURIComponent(termo)}&limit=20`
                )}`)
            ];
            
            for (let i = 0; i < tentativas.length; i++) {
                try {
                    console.log(`Tentativa ${i + 1}...`);
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), 8000);
                    
                    const response = await tentativas[i]();
                    clearTimeout(timeout);
                    
                    if (!response.ok && response.status !== undefined) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Normaliza dados se veio do allorigins
                    const resultados = data.results || data;
                    
                    if (!resultados || resultados.length === 0) {
                        throw new Error('Sem resultados');
                    }
                    
                    const produtos = resultados.map(item => ({
                        ...item,
                        trustScore: getTrustScore(item)
                    })).sort((a, b) => b.trustScore - a.trustScore);
                    
                    renderizarProdutos(produtos, false);
                    return; // Sucesso!
                    
                } catch (erro) {
                    console.log(`Tentativa ${i + 1} falhou:`, erro.message);
                    if (i === tentativas.length - 1) {
                        // √öltima tentativa falhou, usa fallback
                        usarFallback(termo);
                    }
                }
            }
        }
        
        function usarFallback(termo) {
            console.log('Usando produtos de fallback...');
            
            // Filtra produtos de exemplo pelo termo buscado
            const termoLower = termo.toLowerCase();
            const filtrados = PRODUTOS_FALLBACK.filter(p => 
                p.title.toLowerCase().includes(termoLower) ||
                termoLower.includes('fone') ||
                termoLower.includes('bluetooth') ||
                termoLower.includes('headphone')
            );
            
            // Se n√£o encontrou nada espec√≠fico, mostra todos
            const produtos = filtrados.length > 0 ? filtrados : PRODUTOS_FALLBACK;
            
            const produtosComScore = produtos.map(p => ({
                ...p,
                trustScore: getTrustScore(p)
            })).sort((a, b) => b.trustScore - a.trustScore);
            
            renderizarProdutos(produtosComScore, true);
        }
        
        function renderizarProdutos(produtos, isFallback) {
            const resultado = document.getElementById('resultado');
            
            const avisoFallback = isFallback ? `
                <div class="error-box" style="background: #fffbeb; color: #92400e; margin-bottom: 20px;">
                    ‚ö†Ô∏è <strong>Modo de demonstra√ß√£o</strong><br>
                    Mostrando produtos de exemplo. 
                    <button class="retry-btn" onclick="buscar()" style="background: #d97706;">Tentar novamente</button>
                </div>
            ` : '';
            
            resultado.innerHTML = `
                ${avisoFallback}
                <h2 style="margin-bottom: 20px; color: #333;">üèÜ ${produtos.length} produtos encontrados</h2>
                <div class="grid">
                    ${produtos.map(p => {
                        const precoOriginal = p.original_price && p.original_price > p.price 
                            ? `<div class="price-original">${formatarPreco(p.original_price)}</div>` 
                            : '';
                        
                        const frete = p.shipping?.free_shipping ? 'üöö Frete Gr√°tis' : 'Frete a calcular';
                        
                        // Melhora URL da imagem
                        let imgUrl = p.thumbnail || '';
                        if (imgUrl.includes('mlstatic.com')) {
                            imgUrl = imgUrl.replace(/-[A-Z]\.jpg$/, '-O.jpg');
                            imgUrl = imgUrl.replace('http://', 'https://');
                        }
                        
                        return `
                            <div class="card" onclick="abrirModal('${p.id}')">
                                <img src="${imgUrl}" 
                                     alt="${p.title}"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/300x200/667eea/ffffff?text=${encodeURIComponent(p.title.substring(0, 20))}';">
                                <div class="card-body">
                                    <div class="seller">${p.seller?.nickname || 'Vendedor'}</div>
                                    <div class="card-title">${p.title}</div>
                                    ${precoOriginal}
                                    <div class="price">${formatarPreco(p.price)}</div>
                                    
                                    <div class="rating">
                                        <span class="stars">${'‚òÖ'.repeat(Math.round(p.rating_average || 0))}${'‚òÜ'.repeat(5 - Math.round(p.rating_average || 0))}</span>
                                        <span>(${p.rating_total || 0})</span>
                                    </div>
                                    
                                    <div class="trust-badge ${getTrustClass(p.trustScore)}">
                                        <span>üõ°Ô∏è √çndice Acha√≠</span>
                                        <span><strong>${p.trustScore}%</strong> Confi√°vel</span>
                                    </div>
                                    
                                    <div style="font-size: 12px; color: #666; margin-bottom: 12px;">${frete}</div>
                                    
                                    <a href="${criarLinkAfiliado(p.permalink)}" 
                                       class="btn-comprar" 
                                       target="_blank"
                                       onclick="event.stopPropagation()">
                                        ${isFallback ? 'Ver Exemplo üîó' : 'Ver Oferta üîó'}
                                    </a>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            window.produtosCache = produtos.reduce((acc, p) => {
                acc[p.id] = p;
                return acc;
            }, {});
        }
        
        function abrirModal(id) {
            const p = window.produtosCache[id];
            if (!p) return;
            
            let imgUrl = p.thumbnail || '';
            if (imgUrl.includes('mlstatic.com')) {
                imgUrl = imgUrl.replace(/-[A-Z]\.jpg$/, '-O.jpg');
                imgUrl = imgUrl.replace('http://', 'https://');
            }
            
            document.getElementById('modalImg').src = imgUrl;
            document.getElementById('modalImg').onerror = function() {
                this.style.display = 'none';
                this.parentElement.innerHTML = `<div style="height:250px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea,#764ba2);font-size:80px;color:white;">üéß</div>`;
            };
            
            const freteClass = p.shipping?.free_shipping ? 'free' : 'paid';
            const freteTexto = p.shipping?.free_shipping ? 'üöö Frete Gr√°tis' : 'üöö Frete: Consultar';
            
            document.getElementById('modalBody').innerHTML = `
                <div class="modal-title">${p.title}</div>
                <div class="price" style="font-size: 32px; margin-bottom: 5px;">${formatarPreco(p.price)}</div>
                ${p.original_price ? `<div class="price-original" style="font-size: 16px;">De ${formatarPreco(p.original_price)}</div>` : ''}
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value">${p.trustScore}%</div>
                        <div class="stat-label">Confian√ßa</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${(p.rating_average || 0).toFixed(1)}</div>
                        <div class="stat-label">Nota ‚≠ê</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${p.rating_total || 0}</div>
                        <div class="stat-label">Avalia√ß√µes</div>
                    </div>
                </div>
                
                <div class="shipping ${freteClass}">
                    <span style="font-size: 20px;">${p.shipping?.free_shipping ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                    <div>
                        <strong>${freteTexto}</strong>
                        <div style="font-size: 13px; opacity: 0.8;">
                            ${p.shipping?.logistic_type === 'fulfillment' ? 'Enviado pelo Mercado Livre' : 'Enviado pelo vendedor'}
                        </div>
                    </div>
                </div>
                
                <div class="analysis-box">
                    <h4>ü§ñ An√°lise Inteligente</h4>
                    <p>${gerarAnalise(p)}</p>
                </div>
                
                <div style="background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <strong>üè™ Vendedor:</strong> ${p.seller?.nickname || 'N/A'}<br>
                    <strong>üìä Vendas:</strong> ${(p.seller?.seller_reputation?.transactions?.completed || 0).toLocaleString()}<br>
                    <strong>‚≠ê Reputa√ß√£o:</strong> ${p.seller?.seller_reputation?.level_id || 'N/A'}
                </div>
                
                <a href="${criarLinkAfiliado(p.permalink)}" 
                   class="btn-comprar" 
                   target="_blank"
                   style="font-size: 18px; padding: 18px;">
                   üõí ${p.id.startsWith('fb') ? 'VER EXEMPLO (MODO DEMO)' : 'COMPRAR AGORA'}
                </a>
            `;
            
            document.getElementById('modal').style.display = 'flex';
        }
        
        function gerarAnalise(p) {
            const partes = [];
            if (p.trustScore >= 90) partes.push('Produto <strong>altamente confi√°vel</strong>. Excelente custo-benef√≠cio.');
            else if (p.trustScore >= 70) partes.push('Produto com <strong>boa reputa√ß√£o</strong>. Vale a pena considerar.');
            else partes.push('<strong>Aten√ß√£o:</strong> avalie com cuidado antes de comprar.');
            
            if (p.rating_total > 1000) partes.push('Muitas avalia√ß√µes reais de compradores.');
            else if (p.rating_total < 50) partes.push('Poucas avalia√ß√µes. Verifique bem o vendedor.');
            
            if (p.shipping?.free_shipping) partes.push('Frete gr√°tis √© um grande diferencial!');
            
            if (p.original_price && p.price < p.original_price * 0.8) {
                partes.push('üî• <strong>Promo√ß√£o ativa!</strong> Pre√ßo bem abaixo do normal.');
            }
            
            return partes.join(' ');
        }
        
        function fecharModal(event) {
            if (!event || event.target.id === 'modal') {
                document.getElementById('modal').style.display = 'none';
            }
        }
        
        // Busca autom√°tica ao carregar
        setTimeout(buscar, 500);
        
        // Busca ao pressionar Enter
        document.getElementById('searchInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') buscar();
        });
    </script>
</body>
</html>
